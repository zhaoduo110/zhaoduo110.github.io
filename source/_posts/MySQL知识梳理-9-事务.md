---
title: MySQL知识梳理-9.事务
abbrlink: 1704ede5
date: 2021-04-02 15:14:17
categories:
  - - SQL
tags:
  - MySQL
  - SQL
top_img: 'https://could-res-1252778021.cos.ap-shanghai.myqcloud.com/pic/wallpaper/1618218938852.jpg'
cover: 'https://could-res-1252778021.cos.ap-shanghai.myqcloud.com/pic/wallpaper/1618218938852.jpg'
---





# 什么是事务









# 事务的特性

`待完善实现原理`

## A    原子性（Atomicity）

一个事务中的所有操作，要么全部完成要么全部不完成，不会结束在中间的某个环节



## C    一致性（Consistency）

在事务开始之前和事务结束以后，数据库的完整性没有被破坏



## I     隔离性（Isolation）

事务的隔离性要求每个读写事务的对象与其他事务的操作对象能相互分离，即该事务提交前对其他事务都不可见

**INNODB的隔离级别**

- 顺序读（SERIALIZABLE）
- 可重复读（RERPEATABLE READ）
- 读已提交（READ COMMITTED）
- 读未提交（READ UNCOMMITTED）



## D    持久性（Durability）

事务一旦提交了，其结果就是永久性的，就算发生了宕机等事故，数据库也能将数据恢复











# 事务可能带来的问题

高并发的情况下事务可能会出现的问题

**脏读**

在事务A后面那次查询读取到了事务B未提交的数据(此时要修改的操作还在内存中)，导致的事务A中的两次读取结果不一样成为脏读

如果事物B回滚了事务，那么对于事务A来说就是读取到了脏数据，会导致数据最终的不一致

![image-20210402162057059](https://could-res-1252778021.cos.ap-shanghai.myqcloud.com/img/image-20210402162057059.png)

**不可重复读**

在事务A中后面的一次查询读取到了事务B已提交的`修改和删除`操作而导致的事务A中的两次读取结果不一样，称为不可重复读

![image-20210402162510388](https://could-res-1252778021.cos.ap-shanghai.myqcloud.com/img/image-20210402162510388.png)



**幻读**

在事务A中后面那次查询读取到了事务B已提交的`插入的操作` 而导致的事务A中的两次读取结果不一样称为幻读

![image-20210402162813454](https://could-res-1252778021.cos.ap-shanghai.myqcloud.com/img/image-20210402162813454.png)



说明：

1. 脏读与不可重复读、幻读的区别在于脏读是读取到未提交到事务的数据，而不可重复读和幻读都是读取到已提交的事务的数据

2. 不可重复读与幻读的区别在于 不可重复读读取到的是修改和删除的操作，幻读是插入



事务并发带来的三个问题都是 数据读一致性问题，只能通过事务隔离机制来解决



# 事务隔离级别

## MySQL四种事务隔离级别

| 事务隔离级别                     | 脏读   | 不可重复读 | 幻读           | 隔离性 | 性能 |
| -------------------------------- | ------ | ---------- | -------------- | ------ | ---- |
| Read Uncommitted（读未提交）     | 可能   | 可能       | 可能           | 最低   | 最高 |
| Read Committed （读已提交）      | 不可能 | 可能       | 可能           | \|     | ^    |
| Repeatable Read（可重复读）      | 不可能 | 不可能     | 对INNODB不可能 | V      | \|   |
| Serializable（顺序读（串行化）） | 不可能 | 不可能     | 不可能         | 最高   | 最低 |

顺序读隔离性最高，但是性能最低，生产环境不建议使用，为了保证事务一致性 读未提交也不建议使用 。`所以在生产环境 Innodb引擎建议使用Repeatable Read（可重复读）的隔离级别，因为这个隔离级别对INNODB引擎来讲不存在任何事务读取的问题，既保证了性能也解决了数据读一致性问题`



## 实现事务隔离

如果要解决事务数据读一致性问题，保证一个事务前后两次读取数据结果一致，即自己实现事务隔离应该怎么做 ？

### 方案一

LBCC（Lock Based Concurrency Control）：在读取数据前对其加锁，阻止其他事务对数据进行修改

### 方案二

MVCC（Multi Version Concurrency Control）：生成一个数据请求时间点的一致性数据快照（Snapshot），并用这个快照来提供一定级别（语句级或事务级）的一致性读取。undo-log





















